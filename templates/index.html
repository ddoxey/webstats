<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask WebSocket Example with jQuery and Charts</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" integrity="sha384-KA7m0DwgQGmeRC6Xre3hJO+ZxpanOauVh4Czdqbg8lDKJ3bZZYVYmP+y4F31x40L" crossorigin="anonymous"></script>
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        #charts-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: left;
            gap: 20px;
        }
        .chart-container {
            width: 95%;
            position: relative;
        }
        .chart-label {
            text-align: left;
            font-weight: bold;
            margin-bottom: 5px;
        }
        h2 {
            text-align: center;
        }
        .clearfix::after {
            content: "";
            display: block;
            clear: both;
        }
        #config-tab-arrow {
            margin-right: 15px;
            font-weight: bold;
            font-size: 25px;
        }
        #config-tab {
            position: absolute;
            top: 10%;
            right: 365px;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: right center;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px 5px 0 0;
            white-space: nowrap;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        #config-panel {
            position: fixed;
            top: 0;
            right: -350px;  /* Hidden off-screen */
            width: 300px;
            height: 100vh;
            background-color: #f4f4f4;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            transition: right 0.3s;
            padding: 20px;
            border-left: 2px solid #007bff;
        }
        #config-panel h3 {
            margin-top: 0;
        }
        .process-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .process-item input[type="checkbox"] {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h2>Process Monitoring (CPU & Memory Usage)</h2>
    <div class="clearfix" id="charts-container"></div>
    <div id="config-panel">
        <h3>Monitored Processes</h3>
        <div id="process-list"></div>
        <div id="config-tab"><span id="config-tab-arrow">&uarr;</span>Settings</div>
    </div>
    <script>
        const charts = {};  // Store Chart.js instances for each process
        const maxDataPoints = 1000;  // Maximum data points to retain
        const reloadInterval = 5000;
        const startedAt = Date.now();  // Store page load time

        let monitoredProcesses = {{ monitoredProcesses | tojson }}; 

        function renderProcessList() {
            const processList = $('#process-list');
            processList.empty();  // Clear existing content

            monitoredProcesses.forEach((process, index) => {
                const processItem = $(`
                    <div class="process-item">
                        <input type="checkbox" id="process-${index}" ${process.enabled ? 'checked' : ''}>
                        <label for="process-${index}">${process.name}</label>
                    </div>
                `);

                // Add event listener to checkbox
                processItem.find('input').change(function () {
                    monitoredProcesses[index].enabled = this.checked;
                    console.log(monitoredProcesses);  // Debugging log
                });

                processList.append(processItem);
            });
        }

        function emitStatsRequest(socket) {
            console.log('Requesting stats...');
            const enabledProcesses = monitoredProcesses
                .filter(proc => proc.enabled)
                .map(proc => proc.name);
            socket.emit('stats_request', { watch_list: enabledProcesses });
        }

        function getRelativeTime() {
            const now = Date.now();
            return ((now - startedAt) / 1000).toFixed(1);  // Time in seconds
        }

        // Function to create a new chart for a command
        function createChart(command) {
            const canvasId = `chart-${command.replace(/\s+/g, '-')}`;  // Sanitize ID
            const label = $('<div>', { class: 'chart-label', text: `Process: ${command}` });
            const chartDiv = $('<div>', { class: 'chart-container' });
            const canvas = $('<canvas>', { id: canvasId });
            chartDiv.append(canvas);
            $('#charts-container').append(label);
            $('#charts-container').append(chartDiv);

            const ctx = canvas[0].getContext('2d');  // Access raw DOM element from jQuery object

            console.log(`Created canvas: ${canvasId} => ${ctx}`);

            charts[command] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU %',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                            tension: 0.1,
                        },
                        {
                            label: 'Memory %',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                            tension: 0.1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Time (s)' },
                        },
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: 100,
                            title: { display: true, text: '%' },
                        },
                    },
                },
            });
        }

        // Update charts with new data points
        function updateCharts(processes) {
            processes.forEach(process => {
                const command = process.command;
                const cpuUsage = parseFloat(process.cpu) || 0.0;
                const memUsage = parseFloat(process.mem) || 0.0;

                console.log(`Process: ${command}, CPU: ${cpuUsage}, MEM: ${memUsage}`);

                if (!charts[command]) {
                    console.log(`Creating chart for: ${command}`);
                    createChart(command);  // Create chart if it doesn't exist
                }

                const chart = charts[command];
                const now = getRelativeTime();

                // Add new data point to CPU and Memory datasets
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(cpuUsage);
                chart.data.datasets[1].data.push(memUsage);

                // Keep only the last 10 data points
                if (chart.data.labels.length > maxDataPoints) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }

                console.log(`Updating chart: ${command}`);
                chart.update();
                console.log(`Updated chart: ${command}`);
            });
        }

        $(document).ready(function () {
            const socket = io();

            // Handle WebSocket connection
            socket.on('connect', function () {
                console.log('Connected to WebSocket server');
            });

            // Listen for JSON response from the server
            socket.on('stats_response', function (data) {
                if (typeof data === 'object' && data !== null) {
                    updateCharts(data);
                } else {
                    console.error('Invalid data received:', data);
                }
            });

            renderProcessList();

            // Toggle the configuration panel when the tab is clicked
            $('#config-tab').click(() => {
                const panel = $('#config-panel');
                if (panel.css('right') === '0px') {
                    panel.css('right', '-350px');  // Hide the panel
                    $('#config-tab-arrow').html('&uarr;');
                } else {
                    panel.css('right', '0');  // Show the panel
                    $('#config-tab-arrow').html('&darr;');
                }
            });

            emitStatsRequest(socket);
            setInterval(function () { emitStatsRequest(socket); }, reloadInterval);
        });
    </script>
</body>
</html>
